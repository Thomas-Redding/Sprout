<script src="search.js"></script>
<script>

var search;
onload = () => {
  var div = document.getElementById('lorem');
  div.classList.add('search');
  search = new Search(div);
  search.onchange = (value) => {
    spr.send('query\t' + value);
  }
  spr.receive = (message) => {
    var i = message.indexOf('\t');
    if (i == -1) i = message.length;
    var command = message.substr(0, i);
    var arg = message.substr(i+1);
    if (command == 'suggestions') {
      search.setSuggestions(JSON.parse(message.substr(i+1)));
    } else if (command == 'getClipboard') {
      document.getElementById('console').innerHTML = arg.length;
      var input = search.input();
      var newCursorIndex = input.selectionStart + arg.length;
      input.value = input.value.substr(0, input.selectionStart) + arg + input.value.substr(input.selectionEnd);
      input.selectionStart = newCursorIndex;
      input.selectionEnd = newCursorIndex;
    }
  };
  search.onsubmit = (value) => {
    search.setSuggestions([]);
    search.setValue('');
    spr.send('submit\t' + value);
  }
  spr.hotkeyCallbacks.push((c, keyCode, cmd, opt, ctrl, shift) => {
    if (cmd && c == 'v') {
      spr.send('getClipboard');
    } else if (cmd && c == 'c') {
      var input = search.input();
      var selectedString = input.value.substring(input.selectionStart, input.selectionEnd);
      spr.send('setClipboard\t' + selectedString);
    } else {
      var s = '';
      if (cmd) s += 'cmd+';
      if (opt) s += 'opt+';
      if (ctrl) s += 'ctrl+';
      if (shift) s += 'shift+';
      s += c;
      document.getElementById('console').innerHTML = s;
      spr.send('print\t' + s)
    }
  });
}

function disableSmartPunctuationForTextInput(element) {
  // https://stackoverflow.com/a/49139933
  var conversionMap = {};
  conversionMap[ 0x2018 ] = '\'';
  conversionMap[ 0x201B ] = '\'';
  conversionMap[ 0x201C ] = '"';
  conversionMap[ 0x201F ] = '"';
  conversionMap[ 0x2019 ] = '\'';
  conversionMap[ 0x201D ] = '\"';
  conversionMap[ 0x2032 ] = '\'';
  conversionMap[ 0x2033 ] = '"';
  conversionMap[ 0x2035 ] = '\'';
  conversionMap[ 0x2036 ] = '"';
  conversionMap[ 0x2014 ] = '-';
  conversionMap[ 0x2013 ] = '-';
  element.addEventListener('keypress', (event) => {
    if( event.key.length != 1 ) return;
    var code = event.key.codePointAt(0);
    var replacement = conversionMap[code];
    if (replacement) {
      event.preventDefault();
      element.value = element.value.substr(0, lorem.selectionStart) + replacement + element.value.substr(lorem.selectionEnd);
      document.execCommand( 'insertText', 0, replacement );
    }
  });
}

</script>
<style>
body {
  margin: 0;
  background-color: none;
}
.search > input {
  display: block;
  width: 100%;
  background-color: red;
  color: white;
  border: none;
  font-size: 2em;
  margin: 0;
}
.search > table {
  background-color: #333;
  color: white;
  width: 100%;
  border-collapse: collapse;
  cursor: pointer;
  font-size: 2em;
}
.search > table > tbody > tr.selected {
  background-color: #222;
}
</style>
<div id="console" style="color: white;"></div>
<div id="lorem"></div>